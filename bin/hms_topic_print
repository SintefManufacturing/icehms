#!/usr/bin/python

import sys

from icehms import IceManager, Holon, run_holon

class Client(Holon):
    def __init__(self, tn):
        Holon.__init__(self )
        self._tn =  tn
        print("Monitoring all events")

    def get_topics(self):
        topics = self._icemgr.get_all_topics()
        print("Events Topics are: \n")
        top = []
        for name, prx in topics.items():
            top.append(name)
        return top

    def subscribeToAll(self):
        for name in self.get_topics():
            self._subscribe_topic(name)

    def run(self):
        if self._tn:
            self._subscribe_topic(self._tn)
        else:
            self.subscribeToAll()

    def new_event(self, name, stringList, bytesStr, ctx=None):
        pass

    def put_message(self, msg, ctx=None):
        print("New event from: ", msg.sender)

def print_topics():
    mgr = IceManager()
    mgr.init()
    try:
        topics = mgr.get_all_topics()
        print("Events Topics are: \n")
        for name, prx in topics.items():
            print(name)
    finally:
        mgr.shutdown()


def usage():
    print("Usage: ", sys.argv[0], " [-h|--help] [-a|--all] [TopicName]")
    print("")
    print_topics()
    sys.exit(0)


if __name__ == "__main__":
    topicname = None
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        if arg in ("-a", "--all"):
            topicname = None
        elif arg in ("-h", "--help"):
            usage()
        else:
            topciname = arg
    else:
        usage()

    s = Client(topicname)
    run_holon(s)
